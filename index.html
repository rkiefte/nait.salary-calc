// ===============================
// FULL NAIT NASA OLD AGREEMENT GRID (2024â€“2025 pre-GDP)
// ===============================
const BASE_GRID = {
  3: 63461,
  4: 66813,
  5: 70166,
  6: 73517,
  7: 76870,
  8: 82856,
  9: 86319,
  10: 89781,
  11: 93243,
  12: 96606,
  13: 100968,
  14: 104331,
  15: 107693,
  16: 111056,
  17: 114418
};

// GDP adjustments (percentage applied July 1 each year)
const GDP_RATES = {
  2024: 0.03,
  2025: 0.03
};

// ===============================
// UTILITY FUNCTIONS
// ===============================
function addYears(date, years) {
  const d = new Date(date);
  d.setFullYear(d.getFullYear() + years);
  return d;
}

function getJulyFirst(year) {
  return new Date(year, 6, 1); // Month 6 = July
}

function roundCurrency(n) {
  return Math.round(n * 100) / 100;
}

// ===============================
// SALARY TRAJECTORY FUNCTION
// ===============================
function calculateTrajectory(startDateStr, initialStep, endDateStr) {
  const startDate = new Date(startDateStr);
  const endDate = new Date(endDateStr);

  let currentStep = initialStep;
  let currentSalary = BASE_GRID[currentStep];
  let currentDate = new Date(startDate);

  const anniversaryMonth = startDate.getMonth();
  const anniversaryDay = startDate.getDate();

  let segments = [];

  while (currentDate < endDate) {

    // Next anniversary
    let nextAnniversary = new Date(
      currentDate.getFullYear(),
      anniversaryMonth,
      anniversaryDay
    );
    if (nextAnniversary <= currentDate) nextAnniversary = addYears(nextAnniversary, 1);

    // Next July 1
    let nextJuly = getJulyFirst(currentDate.getFullYear());
    if (nextJuly <= currentDate) nextJuly = getJulyFirst(currentDate.getFullYear() + 1);

    // Next event
    let nextEvent = [nextAnniversary, nextJuly, endDate]
      .filter(d => d > currentDate)
      .sort((a, b) => a - b)[0];

    segments.push({
      start: new Date(currentDate),
      end: new Date(nextEvent),
      step: currentStep,
      salary: roundCurrency(currentSalary)
    });

    currentDate = new Date(nextEvent);

    // Apply event
    if (currentDate.getMonth() === anniversaryMonth &&
        currentDate.getDate() === anniversaryDay) {

      // STEP INCREASE
      currentStep += 1;
      if (BASE_GRID[currentStep]) {
        currentSalary = BASE_GRID[currentStep];

        // Apply any GDP that already occurred this year
        Object.keys(GDP_RATES).forEach(year => {
          const july = getJulyFirst(parseInt(year));
          if (july < currentDate) {
            currentSalary *= (1 + GDP_RATES[year]);
          }
        });
      }

    } else if (currentDate.getMonth() === 6 && currentDate.getDate() === 1) {

      // JULY GDP INCREASE
      const year = currentDate.getFullYear();
      if (GDP_RATES[year]) {
        currentSalary *= (1 + GDP_RATES[year]);
      }
    }
  }

  return segments;
}

// ===============================
// EXAMPLE USAGE
// ===============================
const trajectory = calculateTrajectory(
  "2024-10-21",  // Start date
  8,             // Initial step
  "2026-06-30"   // End date
);

console.table(trajectory);